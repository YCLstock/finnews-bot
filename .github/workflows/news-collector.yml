name: News Collector

on:
  schedule:
    # æ¯4å°æ™‚æ”¶é›†ä¸€æ¬¡æ–°è (å°ç£æ™‚é–“ 06:00, 10:00, 14:00, 18:00)
    # å°æ‡‰ UTC: 22:00, 02:00, 06:00, 10:00
    - cron: '0 22,2,6,10 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip xvfb
        # å®‰è£ Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Collect news articles
      timeout-minutes: 15  # è¨­å®š15åˆ†é˜è¶…æ™‚
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        YAHOO_FINANCE_URL: https://finance.yahoo.com/topic/stock-market-news
        SCRAPER_TIMEOUT: 20  # é™ä½å–®ç¯‡æ–‡ç« è¶…æ™‚æ™‚é–“
        DISPLAY: :99
        GITHUB_ACTIONS: true  # æ¨™è­˜GitHub Actionsç’°å¢ƒ
      run: |
        # å•Ÿå‹•è™›æ“¬é¡¯ç¤ºå™¨ï¼ˆSelenium éœ€è¦ï¼‰
        echo "ğŸ–¥ï¸ å•Ÿå‹•è™›æ“¬é¡¯ç¤ºå™¨..."
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        
        # ç­‰å¾…é¡¯ç¤ºå™¨å•Ÿå‹•ä¸¦æª¢æŸ¥Chrome
        sleep 5
        echo "ğŸ” æª¢æŸ¥Chromeå®‰è£..."
        google-chrome --version
        
        # æª¢æŸ¥ChromeDriverå¯ç”¨æ€§å’Œç›®éŒ„çµæ§‹
        echo "ğŸ”§ æº–å‚™ChromeDriver..."
        python -c "
        from webdriver_manager.chrome import ChromeDriverManager
        import os
        driver_path = ChromeDriverManager().install()
        print(f'ChromeDriverè·¯å¾‘: {driver_path}')
        print(f'æ–‡ä»¶å­˜åœ¨: {os.path.exists(driver_path)}')
        if os.path.exists(driver_path):
            import stat
            print(f'æ¬Šé™: {oct(os.stat(driver_path).st_mode)[-3:]}')
        
        # è¨ºæ–·ç›®éŒ„çµæ§‹
        driver_dir = os.path.dirname(driver_path)
        print(f'\\nğŸ“ ç›®éŒ„çµæ§‹è¨ºæ–·:')
        print(f'Driverç›®éŒ„: {driver_dir}')
        
        try:
            for root, dirs, files in os.walk(driver_dir):
                level = root.replace(driver_dir, '').count(os.sep)
                indent = ' ' * 2 * level
                print(f'{indent}{os.path.basename(root)}/')
                subindent = ' ' * 2 * (level + 1)
                for file in files:
                    file_path = os.path.join(root, file)
                    is_exec = os.access(file_path, os.X_OK) if os.path.exists(file_path) else False
                    exec_mark = ' [EXEC]' if is_exec else ''
                    print(f'{subindent}{file}{exec_mark}')
        except Exception as e:
            print(f'ç›®éŒ„æƒæå¤±æ•—: {e}')
        "
        
        # å˜—è©¦æ‰‹å‹•ä¿®å¾©ChromeDriver
        echo "ğŸ”§ å˜—è©¦æ‰‹å‹•ä¿®å¾©ChromeDriver..."
        find /home/runner/.wdm -name "chromedriver" -type f 2>/dev/null | head -5
        
        # æ‰¾åˆ°å¯åŸ·è¡Œçš„chromedriverä¸¦è¨­ç½®æ¬Šé™
        CHROMEDRIVER_PATH=$(find /home/runner/.wdm -name "chromedriver" -type f -executable 2>/dev/null | head -1)
        if [ -n "$CHROMEDRIVER_PATH" ]; then
            echo "âœ… æ‰¾åˆ°å¯åŸ·è¡Œçš„ChromeDriver: $CHROMEDRIVER_PATH"
            chmod +x "$CHROMEDRIVER_PATH"
            ls -la "$CHROMEDRIVER_PATH"
        else
            echo "âŒ æœªæ‰¾åˆ°å¯åŸ·è¡Œçš„ChromeDriver"
            # å˜—è©¦æ‰¾åˆ°ä»»ä½•chromedriveræ–‡ä»¶ä¸¦è¨­ç½®æ¬Šé™
            ALL_CHROMEDRIVERS=$(find /home/runner/.wdm -name "chromedriver" -type f 2>/dev/null)
            for cd_path in $ALL_CHROMEDRIVERS; do
                echo "ğŸ”§ è¨­ç½®æ¬Šé™: $cd_path"
                chmod +x "$cd_path"
                ls -la "$cd_path"
            done
        fi
        
        # åŸ·è¡Œæ–°èæ”¶é›†å™¨
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œæ–°èæ”¶é›†..."
        timeout 10m python run_news_collector.py || echo "âš ï¸ æ–°èæ”¶é›†å™¨åŸ·è¡Œè¶…æ™‚æˆ–å¤±æ•—"
    
    - name: Upload debug screenshots (if any)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: collector-debug-screenshots-${{ github.run_number }}
        path: debug_pages/
        retention-days: 3