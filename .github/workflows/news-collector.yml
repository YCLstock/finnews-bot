name: News Collector

on:
  schedule:
    # æ¯4å°æ™‚æ”¶é›†ä¸€æ¬¡æ–°è (å°ç£æ™‚é–“ 06:00, 10:00, 14:00, 18:00)
    # å°æ‡‰ UTC: 22:00, 02:00, 06:00, 10:00
    - cron: '0 22,2,6,10 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip xvfb
        # å®‰è£ Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Collect news articles
      timeout-minutes: 15  # è¨­å®š15åˆ†é˜è¶…æ™‚
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        YAHOO_FINANCE_URL: https://finance.yahoo.com/topic/stock-market-news
        SCRAPER_TIMEOUT: 20  # é™ä½å–®ç¯‡æ–‡ç« è¶…æ™‚æ™‚é–“
        DISPLAY: :99
        GITHUB_ACTIONS: true  # æ¨™è­˜GitHub Actionsç’°å¢ƒ
      run: |
        # å•Ÿå‹•è™›æ“¬é¡¯ç¤ºå™¨ï¼ˆSelenium éœ€è¦ï¼‰
        echo "ğŸ–¥ï¸ å•Ÿå‹•è™›æ“¬é¡¯ç¤ºå™¨..."
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        
        # ç­‰å¾…é¡¯ç¤ºå™¨å•Ÿå‹•ä¸¦æª¢æŸ¥Chrome
        sleep 5
        echo "ğŸ” æª¢æŸ¥Chromeå®‰è£..."
        google-chrome --version
        
        # æª¢æŸ¥Seleniumå…§å»ºChromeDriverç®¡ç†
        echo "ğŸ¤– ä½¿ç”¨Seleniumå…§å»ºChromeDriverç®¡ç†..."
        python -c "
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        
        print('âœ… Seleniumç‰ˆæœ¬æ”¯æ´è‡ªå‹•ChromeDriverç®¡ç†')
        print('ğŸ“¦ ç„¡éœ€æ‰‹å‹•ä¸‹è¼‰ChromeDriver')
        
        # æ¸¬è©¦åŸºæœ¬Chromeé¸é …
        options = Options()
        options.add_argument('--version')
        print('âœ… Chromeé¸é …é…ç½®æˆåŠŸ')
        "
        
        # åŸ·è¡Œæ–°èæ”¶é›†å™¨
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œæ–°èæ”¶é›†..."
        timeout 10m python run_news_collector.py || echo "âš ï¸ æ–°èæ”¶é›†å™¨åŸ·è¡Œè¶…æ™‚æˆ–å¤±æ•—"
    
    - name: Upload debug screenshots (if any)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: collector-debug-screenshots-${{ github.run_number }}
        path: debug_pages/
        retention-days: 3